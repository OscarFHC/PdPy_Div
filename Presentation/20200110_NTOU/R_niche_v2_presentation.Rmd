---
title: "R_niche_v2 Summarized from R_niche"
output: html_notebook
fontsize: 30 pt
editor_options: 
  chunk_output_type: inline
---

<style type="text/css">

body{ /* Normal  */
      font-size: 20px;
  }
td {  /* Table  */
  font-size: 8px;
}
h1.title {
  font-size: 38px;
}
h1 { /* Header 1 */
  font-size: 28px;
  color: DarkGreen;
}
h2 { /* Header 2 */
    font-size: 22px;
    color: DarkGreen;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
}
code.r{ /* Code block */
    font-size: 12px;
}
pre { /* Code block - determines code spacing between lines */
    font-size: 14px;
}
</style>

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning=FALSE,message=FALSE)

#,self_contained = TRUE

```

```{r library, include=FALSE}
library(data.table)
library(ggplot2)
library(overlapping)
library(reshape2)
library(demogR)
library(ggalt)
library(gridExtra)

```

<!-- # Discussion with colleagues -->

<!-- - CV: explains spatial variance, but not pattern of aggregation (patchiness)  -->

<!--     - What is the relationship between variance and mean? If variance and mean doesn't have a linear or a sort of relationship, it is difficult to interpret what cv means. -->

<!--     - Mean-abundance relationship -->

<!-- - It may be nice to use index of patchiness. -->

<!-- - mean-abundance relationship -->

<!-- - MSY -->

<!-- - Cut the grid so mean density is the same. But when abundance is very low, the grid size is very big and it may not reflect the cv. To calculate CV with different grid size (unit size), I can only compare the CV of high and low differentiation within the same period. i.e. compare 2-10 years high and low, and 11-20 years high and low. I can't compare interannual difference as cv is calculated in different scale. -->

<!-- - Later I can explore how changing fishing intensity may recover fish population/ How long it takes to recover/ whether high spatial differentiation ones may be more vulnerable  -->

<!-- - Leslie matrix: add biomass? to be more realistic -->




# Executive summary

Increase the range of age diversity by:

- increase age classes from 5 to 10 to increase the upper limit of age diversity

- run 40 simulation years to reduce the lower limit of age diversity

- Leslie matrix changes to equal age distribution to increase the upper limit of age diversity

Avoid high variability in cv at low age diversity by:

- increase number of each age from 50 ind to 100 ind

Increase reliability of the results by:

- Run 35 replicates



<!-- The simulation results suggest that: -->

<!-- - The simulation time can be reduced to 0-20 years (even 0-10 years). Age structure stabilises very quickly and age composition doesn't change much with time. We can observe the cv-age relationship clearly already at 0-10 years.  -->

<!-- - Simulation year til 40 years allows for reaching very low age diversity. Yet by that time, the abundnace is very low and CV is then very high. CV can't explain well spatial heterogeneity with high abundance.  -->

<!-- - As both year and mortality alter age diversity, it is better to reduce simulation year to 0-20 (or 0-15) and to add more severe fishing scenario (50% and lower). More severe fishing scenario reduces age diversity, and if we observe in early years, abundance is not yet very low. In this case, CV serves as a better indicator for spatial heterogeneity. Within the same year range, severe fishing results in clear differences in age-cv relationship between high and low spatial differentiation. -->

<!-- - It is nice to keep 10 age classes as it increases the upper limit of age diversity. -->

<!-- - It is nice to keep Leslie matrix with equal age composition. It increases the upper limit of age diversity. -->

<!-- - It is nice to keep individual number of 100. This could stabilise CV, preventing CV to be very high with low abundance. -->

<!-- # Other notes: -->

<!-- - I can set 30 steps as one year, as in 30 steps fish can move to its preferred place. It saves computation power. -->

<!-- - Ideal free distribution using *proportional model* can avoid changes in population oppulation area when population size changes, as in this theory, spatial coverage is independent of population size. The total coverage of the population distribution is therefore fixed. This setting may help with interpretation of cv. So that cv is determined by spatial heterogeneity but not range. Yet, if carrying capacity is set small, then there will be an expansion in the occupying area. -->

<!-- ![](Pic_sherpherd.png) -->

<!-- - Fishing scenario strongly determines the changes in abundance and age structure. It is interesting to explore how different fishing mortality (overall strength, or differences between age) may alter the age structure and abundance.  -->

<!-- - *Spatial indicator that calculate "patchiness" may capture more spatial heterogeneity differences between high and low spatial differentiaton scenarios.* -->
<!--     - Lloyd's index (Morista) -->


<!-- - Set up a stronger high spatial differentiation: the peaks are between 0.1 and 0.9, or 0.05 and 0.95. Then the niche breadth would be shorter. I may then use a narrow bell shape beta distribution with lower alpha and beta values (in this case the age-specific differentation is stonger), and that the population still distribute throughout the landscape including the margins. -->


<!-- # Degree of overlap -->
<!-- Olsen 2010 Barent Sea -->
<!-- North Sea -->






<!-- # Set up 2 spatial differentiation scenarios using beta distribution, 10 age classes  -->

<!-- - Alpha and beta determines the shape of the beta distribution.  -->

<!-- - When alpha and beta > 2, it is bell shaped. The higher the values the narrower the bell. -->

<!-- - When alpha and beta is between 1 and 2, the density distribution is closer to uniform. In this case,the margin cell have more occupation. -->

<!-- - In Mobydic, I choose alpha and beta as 1.2 so that the individuals covers the whole landscape. If alpha and beta are set too high, individuals do not cover the margin cells especially under low spatial differentiation scenario. -->

<!-- - According to niche theory of "limiting similarity", "the distance between two consumersâ€™ resource use curves could not be smaller than one standard deviation of those curves" (Andreas 2016). Although there are revisions on this theory, I could still consider that the resource curve of neighbors should not be too close. -->

<!--     - I can set up peaks between 0.1 and 0.9. Then I can use higher alpha and beta (narrower bell shape) while othe overlap is not so big. -->

<!-- - With the current setting, the closest neighboring curves have overlap of 65. For distant curves the overlap would be 0 (no overlap). -->


# High spatial differentiation: peaks between 0.2 and 0.8
alpha, beta= 1.2
```{r 9 age class mean from 0.2 to 0.8,echo=FALSE}


# Create 9 distributions
create_distribution<-function(n,a,b,lb,ub){
  set.seed(8) # I use this seed for Mobydic
  beta<-rbeta(n,a,b)
  gap <- (ub-lb)/8
  range <- lb*2
  data<-matrix(NA,ncol=9,nrow=n) # create an empty matrix 
  for (i in 1:9){
    data[,i]<-gap*(i-1)+range*beta
  }
  data_plot<-melt(as.data.frame(data)) 
  # transform to long form. Need to convert to data.frame in order to use "melt function"
  
  colnames(data_plot)<-c("age", "beta")
  data_overlay<-split(data, rep(1:ncol(data), each = nrow(data))) 
  # split columns of a matrix into a list of vectors
  
  data_list<-list(data_overlay,data_plot) 
}

# Plot with 1000000 data
dd<-create_distribution(1000000,1.2,1.2,0.2,0.8)
ggplot(dd[[2]], aes(beta, fill = age)) + geom_density(alpha = 0.2)+xlim(0,1)+ylim(0,3)+ylab("Habitat preference")+xlab("Habitat gradient")

# # Calculate overlap area with 100 data
# dd<-create_distribution(100,1.2,1.2,0.2,0.8)
# out <- overlap(dd[[1]], plot=TRUE)
# #out$OV

```


# Low spatial differentiation: peaks between 0.4 and 0.6
```{r 9 age class mean from 0.4 to 0.6, echo=FALSE}

# Create 9 distributions
create_distribution<-function(n,a,b,lb,ub){
  set.seed(8) # I use this seed for Mobydic
  beta<-rbeta(n,a,b)
  gap <- (ub-lb)/8
  range <- lb*2
  data<-matrix(NA,ncol=9,nrow=n) # create an empty matrix 
  for (i in 1:9){
    data[,i]<-gap*(i-1)+range*beta
  }
  data_plot<-melt(as.data.frame(data)) 
  # transform to long form. Need to convert to data.frame in order to use "melt function"
  
  colnames(data_plot)<-c("age", "beta")
  data_overlay<-split(data, rep(1:ncol(data), each = nrow(data))) 
  # split columns of a matrix into a list of vectors
  
  data_list<-list(data_overlay,data_plot) 
}

# Plot with 1000000 data
dd<-create_distribution(1000000,1.2,1.2,0.4,0.6)
ggplot(dd[[2]], aes(beta, fill = age)) + geom_density(alpha = 0.2)+xlim(0,1)+ylim(0,3)+ylab("Habitat preference")+xlab("Habitat gradient")

# # Calculate overlap area with 100 data
# dd<-create_distribution(100,1.2,1.2,0.4,0.6)
# out <- overlap(dd[[1]], plot=TRUE)
# #out$OV

```


<!-- # Mobydic: create a sereis of beta distribution -->
<!-- In Mobydic, I drew 100 values from a beta distribution (alpha and beta as 1.2), rescale and assigned to 10 age classes. -->

<!-- ```{r 50 numbers as serie for Mobydic input set.seed(8), include=FALSE} -->

<!-- # Draw from a beta distribution with alpha & beta as 2 -->
<!-- set.seed(8) -->
<!-- d<-rbeta(50,2,2) -->
<!-- d -->
<!-- write.table(d, "beta_50.txt", row.names=FALSE)  -->

<!-- # Draw from a beta distribution with alpha & beta as 1.2 -->
<!-- set.seed(8) -->
<!-- d<-rbeta(50,1.2,1.2) -->
<!-- d -->
<!-- write.table(d, "beta_50_smallab.txt", row.names=FALSE)  -->

<!-- # Draw from a beta distribution with alpha & beta as 1.2, with 100 values -->
<!-- set.seed(8) -->
<!-- d<-rbeta(100,1.2,1.2) -->
<!-- d -->
<!-- write.table(d, "beta_100_smallab.txt", row.names=FALSE)  -->

<!-- ``` -->


# Hypothesis
![](Pic_hypothesis_2.png)



# Leslie matrix
I first tried a Leslie matrix mimicking North Sea cod (Experiment 191202). Then, in order to increase age diversity range, I switched to uniform age structure in the next experiment (F35).

```{r plot.leslie function for later use, include=FALSE}

# plot leslie
plot.leslie<-function(x,n){
  project<-project.leslie(A=x, no=rep(n,times=9), tmax=30, pop.sum = FALSE)
  project.sum<-rbind(project,colSums(project))
  project.sum.time<-rbind(seq(from=1,to=101,by=1),project.sum)
  rownames(project.sum.time)<-c("time","a1","a2","a3","a4","a5","a6","a7","a8","a9","total_population")
  y<-project.sum.time
  d1<-melt(as.data.table(t(y)),measure.vars = patterns("a"),value.name = c("number")) 
  # transpose y, then melt ages in one column
  ggplot(d1, aes(x=time,y=number,color=variable))+geom_line()+
  theme_bw()+
    theme(panel.grid.major = element_blank(), axis.line
                    =element_line(colour = "black"))
  
}

```


## 1 Leslie matrix mimicking pelagic cod in the North Sea
- Natural mortality of cod (ICES 2014 Report): Age 1: 0.8, age 2: 0.35, age 3: 0.25m age 4+:0.2
- I used the following marix for the first trial (Experiment 191202:F287S0802REP10 & F287S0406REP10 & F2870802REP20 & F2870406REP20)

Recruitment for age 1-9: 0.1, 0.2, 0.3, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4
Survival for age 1-9: 0.5, 0.8, 0.9, 0.9, 0.9, 0.9, 0.9, 0.9, 0

<!-- -From eigen analysis: -->

<!-- lambda is 0.998 -->

<!-- stable.age -->
<!-- [1] 0.27794958 0.13912584 0.11142165 0.10038848 0.09044784 0.08149153 0.07342210 0.06615171 -->
<!-- [9] 0.05960125 -->

<!-- repro.value -->
<!-- [1] 1.0000000 1.7978285 1.9948456 1.8807552 1.6430147 1.3791453 1.0862754 0.7612178 0.4004348 -->


<!-- The estimated Shannon index at year 30 under survival rate (age 5-8) from 100% to 10% are: -->
<!-- 2.081520 2.066643 2.043118 2.009963 1.966793 1.914255 1.854312 1.790050 1.724671 1.659153 -->
<!-- (100 individuals at each age) -->

<!-- *Age structure stabilised at around year 15. When alter Shannon index estimation by different years, Shannon index doesn't change much between year 15 and year 30.* -->

```{r Leslie matrix mimicking pelagic cod in the North Sea, echo=FALSE }

knitr::opts_chunk$set(echo = TRUE, warning=FALSE)


lesmat<-matrix(c(
  0.1,0.2,0.3,0.4,0.4,0.4,0.4,0.4,0.4,

  0.5,0,0,0,0,0,0,0,0,

  0,0.8,0,0,0,0,0,0,0,

  0,0,0.9,0,0,0,0,0,0,

  0,0,0,0.9,0,0,0,0,0,
  
  0,0,0,0,0.9,0,0,0,0,
  
  0,0,0,0,0,0.9,0,0,0,
  
  0,0,0,0,0,0,0.9,0,0,
  
  0,0,0,0,0,0,0,0.9,0

),nrow=9, ncol=9, byrow=TRUE)

# eigen.analysis(lesmat)

# Plot Leslie
plot.leslie(lesmat,n=100)

# Shannon estimation
Calculate.Shannon<-function(a,n,year){
  lesmat<-matrix(c(
  0.1,0.2,0.3,0.4,0.4,0.4,0.4,0.4,0.4,
  0.5,0,0,0,0,0,0,0,0,
  0,0.8,0,0,0,0,0,0,0,
  0,0,0.9,0,0,0,0,0,0,
  0,0,0,0.9,0,0,0,0,0,
  0,0,0,0,a,0,0,0,0,
  0,0,0,0,0,a,0,0,0,
  0,0,0,0,0,0,a,0,0,
  0,0,0,0,0,0,0,a,0
),nrow=9, ncol=9, byrow=TRUE)
  project<-project.leslie(A=lesmat, no=c(rep(n,times=9)), tmax=30, pop.sum = FALSE)
  project.sum<-rbind(project,colSums(project)) # Add a 10th row of the summation of age 1-9
  project.sum.time<-rbind(seq(from=1,to=101,by=1),project.sum) # Add a first row as time
  dd<-project.sum.time
  c<-dd[2:10,year]/dd[11,year] 
  return(sum(-c*log(c))) 
}

# Shannon from survival rate of 100% (1) to 10% (0.1)

dd<-vector()
for (i in 1:10){
  dd[i]<-Calculate.Shannon(1-0.1*(i-1),100,30)
}
dd

```


## 2 Leslie matrix with even age structure
In order to increase age diversity range, I used a Leslie matrix to create an even age structure for experiment F35:
Recruitment for age 1-9: all is 0.111.
Survival for age 1-9: all 1 (no natural mortality).

<!-- From eigen analysis: -->
<!-- $stable.age -->
<!-- [1] 0.1110222 0.1110444 0.1110666 0.1110889 0.1111111 0.1111333 0.1111556 0.1111778 0.1112001 -->

<!-- $repro.value -->
<!-- [1] 1.0000000 0.8887999 0.7776221 0.6664666 0.5553332 0.4442221 0.3331333 0.2220666 0.1110222 -->

<!-- *For this matrix, age structure stabilises from the first year.* -->

<!-- The Shannon estimation at 30 years, with 100 individuals per age are: -->
<!-- 2.197224 2.192143 2.175298 2.144511 2.098231 2.036294 1.960620 1.875281 1.785172 1.692293 -->

<!-- Comparing to Leslie matrix mimicking North Sea cod: -->
<!-- 2.081520 2.066643 2.043118 2.009963 1.966793 1.914255 1.854312 1.790050 1.724671 1.659153 -->

<!-- Leslie matrix with even age structure have higher age diversity range because the maximum age diversity is higehr (2.19 versus 2.08). -->

```{r even age structure, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE)

lesmat<-matrix(c(
  0.111,0.111,0.111,0.111,0.111,0.111,0.111,0.111,0.111,

  1,0,0,0,0,0,0,0,0,

  0,1,0,0,0,0,0,0,0,

  0,0,1,0,0,0,0,0,0,

  0,0,0,1,0,0,0,0,0,
  
  0,0,0,0,1,0,0,0,0,
  
  0,0,0,0,0,1,0,0,0,
  
  0,0,0,0,0,0,1,0,0,
  
  0,0,0,0,0,0,0,1,0

),nrow=9, ncol=9, byrow=TRUE)

# eigen.analysis(lesmat)

# Plot Leslie
plot.leslie(lesmat,n=100)

# Shannon estimation
Calculate.Shannon<-function(a,n,year){
  lesmat<-matrix(c(
  0.111,0.111,0.111,0.111,0.111,0.111,0.111,0.111,0.111,
  1,0,0,0,0,0,0,0,0,
  0,1,0,0,0,0,0,0,0,
  0,0,1,0,0,0,0,0,0,
  0,0,0,1,0,0,0,0,0,
  0,0,0,0,a,0,0,0,0,
  0,0,0,0,0,a,0,0,0,
  0,0,0,0,0,0,a,0,0,
  0,0,0,0,0,0,0,a,0
),nrow=9, ncol=9, byrow=TRUE)
  project<-project.leslie(A=lesmat, no=c(rep(n,times=9)), tmax=30, pop.sum = FALSE)
  project.sum<-rbind(project,colSums(project)) # Add a 10th row of the summation of age 1-9
  project.sum.time<-rbind(seq(from=1,to=101,by=1),project.sum) # Add a first row as time
  dd<-project.sum.time
  c<-dd[2:10,year]/dd[11,year] 
  return(sum(-c*log(c))) 
}

# Shannon from survival rate of 100% (1) to 10% (0.1)
dd<-vector()
for (i in 1:10){
  dd[i]<-Calculate.Shannon(1-0.1*(i-1),100,30)
}
#dd


```


<!-- # Summary of Leslie & Shannon exploration   -->
<!-- 1. Age distribution is stabilised around 15 years for Leslie matrix mimicking North Sea cod, while equal age distribution stabilised at year 1. -->

<!-- 2. By starting with survival rate of 1 and equal recruitment rates between ages, -->
<!-- we allow for an uniform age structure with high shannon index (2.19). -->

<!-- 3. Comparing unequal age distribution and equal age distribution, equal distribution has higher maximum age diversity. This leads to wider age diverity range than unequal age distribution setting. -->






<!-- # Experiment 191202 F287S0802REP10 & F287S0406REP10  -->
<!-- Run on Mobydic F287Class9 -->

<!-- Spatial differentiation scenario: -->
<!-- 1. Strong spatial differntiation: range between 0.2 and 0.8 -->
<!-- 2. Weak spatial differentiation: range between 0.4 and 0.6 -->

<!-- Survival rates of age 5,6,7,8 are: -->
<!-- 90,90,90,90 -->
<!-- 80,80,80,80 -->
<!-- 70,70,70,70 -->
<!-- 60,60,60,60 -->

<!-- Time: 1200 steps (30 years). Every 40 time steps is one year. -->
<!-- Space: 11 rows, 11 columns -->
<!-- Individuals: 50 individuals per age class -->
<!-- Replicate: 10 replications (for F287S0802REP10 & F287S0406REP10) -->
<!-- Leslie matrix: mimicking North Sea cod -->
<!-- Recruitment for age 1-9: 0.1, 0.2, 0.3, 0.4, 0.4, 0.4, 0.4, 0.4, 0.4 -->
<!-- Survival for age 1-9: 0.5, 0.8, 0.9, 0.9, 0.9, 0.9, 0.9, 0.9, 0 -->

<!-- ```{r PART4 read F287S0802REP10.txt, include=FALSE} -->

<!-- library(tidyverse) -->
<!-- library(data.table) -->
<!-- library(mapplots) -->
<!-- library(purrr) -->
<!-- library(ggplot2) -->
<!-- library(forcats) -->
<!-- library(viridis) -->

<!-- # use read.delim to read txt  -->
<!-- d<-read.delim("F287S0802REP10.txt",skip = 46,header = F,fill = T,sep = "",strip.white = T, blank.lines.skip = T) # value of "skip" is row of the first line of the data. -->
<!-- d  -->

<!-- # transpose data in data.table -->
<!-- tt<-t(d) -->
<!-- dt<-as.data.table(tt) -->
<!-- colnames(dt)=as.character(dt[1,]) # use the row name of the first row as colnames -->
<!-- dt <- dt[-1,] # delete this fist row -->

<!-- # use melt to combine columns into new columns -->
<!-- dt<-melt(dt,measure.vars = patterns("^lshannon#","lcv#","^la1#","^la2#","^la3#","^la4#","^la5#","^la6#","^la7#","^la8#","^la9#"), -->
<!--          value.name = c("shannon","cv","a1","a2","a3","a4","a5","a6","a7","a8","a9")) -->
<!-- dt -->
<!-- str(dt) -->

<!-- # Remove first two columns without meaningful variables, and add columns -->
<!-- dtt<-dt[,-c(1:2)] # Remove first two unmeaningful columns -->
<!-- dtt[,time_step:=rep.int(1:1200,times=40)] # 1200 time steps repeat for 40 times per variable (4 fishing scenario x 10 replicate) -->
<!-- dtt[,week:=rep.int(1:40,times=1200)] # 40 weeks for 30 years, 40 times per variable=30*40=1200 -->
<!-- dtt[,replicate:=rep(rep(1:10,each=1200),4)] # Repeat 10 times for 4 survival scenarios x 0 sd=4 -->
<!-- dtt[,survival_coef:=rep(c("S9090","S8080","S7070","S6060"),each=1200*10)] # 0 sd x 10 replicate -->
<!-- dtt[,niche:=0208] -->
<!-- dtt[,year:=rep(rep(1:30,each=40),times=40)] -->


<!-- # convert some variables to numeric using lapply, SD, SDcols -->
<!-- str(dtt) -->
<!-- strTmp = c('shannon','cv','a1','a2','a3','a4','a5','a6','a7','a8','a9') -->
<!-- dtt[, (strTmp) := lapply(.SD, as.numeric), .SDcols = strTmp] -->

<!-- # calculate population size -->
<!-- dtt[, population_size := rowSums(.SD), .SDcols = c("a1","a2","a3","a4","a5","a6","a7","a8","a9")] -->
<!-- F287_S0208<-dtt -->

<!-- ``` -->


<!-- ```{r PART4 read F287S0406REP10.txt, include=FALSE} -->

<!-- # use read.delim to read txt  -->
<!-- d<-read.delim("F287S0406REP10.txt",skip = 46,header = F,fill = T,sep = "",strip.white = T, blank.lines.skip = T) -->
<!-- d -->

<!-- # transpose data in data.table -->
<!-- tt<-t(d) -->
<!-- dt<-as.data.table(tt) -->
<!-- colnames(dt)=as.character(dt[1,]) # use the row name of the first row as colnames -->
<!-- dt <- dt[-1,] # delete this fist row -->

<!-- # use melt to combine columns into new columns -->
<!-- dt<-melt(dt,measure.vars = patterns("^lshannon#","lcv#","^la1#","^la2#","^la3#","^la4#","^la5#","^la6#","^la7#","^la8#","^la9#"), -->
<!--          value.name = c("shannon","cv","a1","a2","a3","a4","a5","a6","a7","a8","a9")) -->
<!-- dt -->
<!-- str(dt) -->

<!-- # Remove first two columns without meaningful variables, and add columns -->
<!-- dtt<-dt[,-c(1:2)] # Remove first two unmeaningful columns -->
<!-- dtt[,time_step:=rep.int(1:1200,times=40)] # 1200 time steps repeat for 40 times per variable (4 fishing scenario x 10 replicate) -->
<!-- dtt[,week:=rep.int(1:40,times=1200)] # 40 weeks for 30 years, 40 times per variable=30*40=1200 -->
<!-- dtt[,replicate:=rep(rep(1:10,each=1200),4)] # Repeat 10 times for 4 survival scenarios x 0 sd=4 -->
<!-- dtt[,survival_coef:=rep(c("S9090","S8080","S7070","S6060"),each=1200*10)] # 0 sd x 10 replicate -->
<!-- dtt[,niche:=0406] -->
<!-- dtt[,year:=rep(rep(1:30,each=40),times=40)] -->


<!-- # convert some variables to numeric using lapply, SD, SDcols -->
<!-- str(dtt) -->
<!-- strTmp = c('shannon','cv','a1','a2','a3','a4','a5','a6','a7','a8','a9') -->
<!-- dtt[, (strTmp) := lapply(.SD, as.numeric), .SDcols = strTmp] -->

<!-- # calculate population size -->
<!-- dtt[, population_size := rowSums(.SD), .SDcols = c("a1","a2","a3","a4","a5","a6","a7","a8","a9")] -->
<!-- F287_S0406<-dtt -->

<!-- # 3 Bind two files -->
<!-- f287<-bind_rows(F287_S0208,F287_S0406) -->
<!-- summary(f287) -->

<!-- # 4 reorder for later plots -->
<!-- f287$survival_coef = factor(f287$survival_coef, levels=c('S9090','S8080','S7070','S6060')) -->
<!-- f287$survival_coef=as.character(f287$survival_coef) -->

<!-- #5 Rename mean, sd, and values -->
<!-- f287$niche<-as.character(f287$niche) -->
<!-- str(f287) -->
<!-- ``` -->

<!-- ## CV~age  -->
<!-- The starting point at high age diversity differs between strong and week differentiation. -->
<!-- When using year 10:20, the pattern is clearer. -->

<!-- ```{r, include=FALSE} -->
<!-- # cv~age diversity -->
<!-- f287[year %in% c(10:20) & week %in% c(38:39) & survival_coef %chin% c("S9090","S8080","S7070")] %>% -->
<!--    ggplot(aes(x=shannon, y=cv,color=niche)) + -->
<!--    geom_point(pch=1,cex=0.8)+ -->
<!--    #geom_smooth(method="loess")+ -->
<!--    ggtitle("")+ -->
<!--    theme(plot.title = element_text(hjust = 0))+ -->
<!--    labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+ -->
<!--    guides(color=guide_legend("Survival rate of \nage 3 and age 4")) -->
<!-- ``` -->

<!-- # CV~age by fishing scenario  -->
<!-- 1. Intensive fishing have high variability in age diversity and cv. -->
<!-- 2. Low age dviersity occurs under intensive fishing scenario. -->
<!-- 3. Intensive fishing creates low age diversity at year 20-30 (see below graph) -->
<!-- 4. Different slopes between fishing scenarios can be due to differences in abundance. -->
<!-- i.e for intensive fishing, abundance is very low and thus cv increaes quickly. -->
<!-- 5. Age diversity is created *both by different fishing scenarios and different year.*  -->
<!-- 6. Different fishing scenarios creates different abundance. Thus, the more fishing scenarios we include, we may find high variability in CV with the same age diversity. -->
<!-- 8. Maybe we should at one time only choose one fishing scenario, and compare strong vs weak. -->


<!-- ```{r, include=FALSE} -->
<!-- # Group by survival_coef -->
<!-- f287[year %in% c(1:30) & week %in% c(38:39) & survival_coef %chin% c("S9090","S8080","S7070","S6060")] %>% -->
<!--    ggplot(aes(x=shannon, y=cv,color=survival_coef)) + -->
<!--    geom_point(pch=1,cex=0.8)+ -->
<!--    geom_smooth(method="lm")+ -->
<!--    ggtitle("")+ -->
<!--    theme(plot.title = element_text(hjust = 0))+ -->
<!--    labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+ -->
<!--    guides(color=guide_legend("Survival rate of \nage 3 and age 4")) -->
<!-- ``` -->



<!-- # CV~age by year -->
<!-- When year >20, CV remains high across age diversity. -->
<!-- Low age diversity occurs at later years (between 20 and 30 years) -->

<!-- ```{r, include=FALSE} -->

<!-- f287[year %in% c(1:30) & week %in% c(38:39) & survival_coef %chin% c("S9090","S8080","S7070")] %>% -->
<!--    ggplot(aes(x=shannon, y=cv,color=year)) + -->
<!--    geom_point(pch=1,cex=0.8)+ -->
<!--    geom_smooth(method="loess")+ -->
<!--    ggtitle("")+ -->
<!--    theme(plot.title = element_text(hjust = 0))+ -->
<!--    labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+ -->
<!--    guides(color=guide_legend("Survival rate of \nage 3 and age 4")) -->


<!-- f287[year %in% c(1:30) & week %in% c(38:39) & survival_coef %chin% c("S9090","S8080","S7070")] %>% -->
<!--    ggplot(aes(x=shannon, y=cv)) + -->
<!--    geom_point(pch=1,cex=0.8)+ -->
<!--    geom_smooth(method="loess")+ -->
<!--    facet_wrap(~year, scales="fixed",strip.position = "top",as.table=F,ncol=4)+ -->
<!--    ggtitle("")+ -->
<!--    theme(plot.title = element_text(hjust = 0))+ -->
<!--    labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+ -->
<!--    guides(color=guide_legend("Survival rate of \nage 3 and age 4")) -->
<!-- ``` -->


<!-- ## Summary of Experiment 191202  -->
<!-- 1. After 20 years the abundance decreases dramatically, and cv can increases to quite high. -->
<!-- Perhaps it makes sense not to take into account after 20 years. -->

<!-- 2. Fishing survival rate of 60% 60% reduces abundance dramatically.  -->
<!-- Perhaps it makes sense not to take into account for this scenario -->

<!-- 3. Current fishing scenario setting can be improved to enable lower age diversity. -->
<!-- Or to set more intensive fishing scenario by reducing survival rate to below 60%, -->
<!-- but look at just between 10 and 20 years. -->

<!-- *4. The key is to be able to create a large gradient of age diversity while keep the abundance high (not drop too quickly). So to adjust age structure but not altering abundance that much.* -->

<!-- 5. Try to plot age structure under different fishing scenarios to confirm the pattern. -->

<!-- *6.When fishing mortality is high, age-cv relationship is more variable. So we may need more replicates*   -->


<!-- ## Next: -->
<!-- 1. Think how to deal with different cv~age slope by different fishing scenarios (maybe due to different abundance altering CV). Maybe I should compare strong vs weak differentiation under each fishing scenarios. -->
<!-- 2. Change beta distribution toward more uniform like -->
<!-- 3. Change Leslie to equal age distribtuion for initial condition. Maybe run on Mobydic first to see if increase alpha & beta will fill the landscape.  -->
<!-- 4. Run in Mobydic different fishing scenarios. Choose fishing mortality scenarios to simulate. -->
<!-- *5. Increase number of individuals for each age class*-> this allows simulation to run more years and to reach lower age diversity while cv is not yet surging high. -->




<!-- # Experiment 191205 F289_S0208R10 -->
<!-- Run on Mobydic F289BetaMortality -->

<!-- In this Mobydic version, I changed: -->
<!-- 1. Beta distribution parameters (alpha, beta) from (2,2) to (1.2,1.2) -->
<!-- 2. Same reproduction and survival rates across all ages (equal age composition) -->

<!-- Spatial differentiation scenario: -->
<!-- 1. Strong spatial differntiation: range between 0.2 and 0.8 -->
<!-- 2. Weak spatial differentiation: range between 0.4 and 0.6 -->

<!-- Survival rates of age 5,6,7,8 are: (in total 6 scenarios) -->
<!-- 50,50,50,50 -->
<!-- 60,60,60,60 -->
<!-- 70,70,70,70 -->
<!-- 80,80,80,80 -->
<!-- 90,90,90,90 -->
<!-- 100,100,100,100 -->


<!-- Time: 800 steps (20 years). Every 40 time steps is one year. -->
<!-- Space: 11 rows, 11 columns -->
<!-- Individuals: 50 individuals per age class -->
<!-- Replicate: 10 replications (for F287S0802REP10 & F287S0406REP10)  -->




<!-- ## Results on F289_S0208R20 -->
<!-- I run one set of simulations (F289_S0208R20). -->
<!-- I found that age diversity doesn't decrease much after 20 years (800 steps) -->
<!-- And CV doesn't increase that much. -->
<!-- I didn't run other differentiation scenarios or do the plotting, -->
<!-- just look at the excel output. -->


<!-- I decided to create F35FishInd10. -->
<!-- This is to increase the number of individuals to 100 per age. -->
<!-- I hope then to be able to run more years, -->
<!-- with more reduction in age diversity, and increase in CV.  -->




<!-- # Experiment 191206 F35_S0208R5, F25_S0406R5 -->
<!-- Run on Mobydic F35Ind10 -->

<!-- Spatial differentiation scenario (alpha, beta=1,2) -->
<!-- 1. Strong spatial differntiation: range between 0.2 and 0.8 -->
<!-- 2. Weak spatial differentiation: range between 0.4 and 0.6 -->

<!-- Survival rates of age 5,6,7,8 are: (in total 6 scenarios) -->
<!-- 50,50,50,50 -->
<!-- 60,60,60,60 -->
<!-- 70,70,70,70 -->
<!-- 80,80,80,80 -->
<!-- 90,90,90,90 -->
<!-- 100,100,100,100 -->

<!-- Time: 1600 steps (40 years). Every 40 time steps is one year. -->
<!-- Space: 11 rows, 11 columns -->
<!-- Individuals: 100 individuals per age class -->
<!-- Replicate: 5 replicates -->
<!-- Demography: equal age composition -->


```{r F35_S0208R5.txt, include=FALSE}

library(tidyverse)
library(data.table)
library(mapplots)
library(purrr)
library(ggplot2)
library(forcats)
library(viridis)

# use read.delim to read txt 
d<-read.delim("F35_S0208R5.txt",skip = 36,header = F,fill = T,sep = "",strip.white = T, blank.lines.skip = T) # value of "skip" is row of the first line of the data.
d 

# transpose data in data.table
tt<-t(d)
dt<-as.data.table(tt)
colnames(dt)=as.character(dt[1,]) # use the row name of the first row as colnames
dt <- dt[-1,] # delete this fist row

# use melt to combine columns into new columns
dt<-melt(dt,measure.vars = patterns("^lshannon#","lcv#","^la1#","^la2#","^la3#","^la4#","^la5#","^la6#","^la7#","^la8#","^la9#"),
         value.name = c("shannon","cv","a1","a2","a3","a4","a5","a6","a7","a8","a9"))
dt
str(dt)

# Remove first two columns without meaningful variables, and add columns
dtt<-dt[,-c(1:2)] # Remove first two unmeaningful columns
dtt[,time_step:=rep.int(1:1600,times=30)] # 1600 time steps repeat for 30 times per variable (6 fishing scenario x 5 replicate)
dtt[,week:=rep.int(1:40,times=1200)] # 40 weeks for 40 years, 30 times per variable=40*30=1200
dtt[,replicate:=rep(rep(1:5,each=1600),6)] # Repeat 5 times for 6 survival scenarios x 0 sd=6
dtt[,survival_coef:=rep(c("S5050","S6060","S7070","S8080","S9090","S100100"),each=1600*5)] # 0 sd x 5 replicate
dtt[,year:=rep(rep(1:40,each=40),times=30)]
dtt[,niche:=0208]


# convert some variables to numeric using lapply, SD, SDcols
str(dtt)
strTmp = c('shannon','cv','a1','a2','a3','a4','a5','a6','a7','a8','a9')
dtt[, (strTmp) := lapply(.SD, as.numeric), .SDcols = strTmp]

# calculate population size
dtt[, population_size := rowSums(.SD), .SDcols = c("a1","a2","a3","a4","a5","a6","a7","a8","a9")]
F35_S0208<-dtt


```


```{r F35_S0406R5.txt, include=FALSE}

# use read.delim to read txt 
d<-read.delim("F35_S0406R5.txt",skip = 36,header = F,fill = T,sep = "",strip.white = T, blank.lines.skip = T)
d

# transpose data in data.table
tt<-t(d)  
dt<-as.data.table(tt)
colnames(dt)=as.character(dt[1,]) # use the row name of the first row as colnames
dt <- dt[-1,] # delete this fist row

# use melt to combine columns into new columns
dt<-melt(dt,measure.vars = patterns("^lshannon#","lcv#","^la1#","^la2#","^la3#","^la4#","^la5#","^la6#","^la7#","^la8#","^la9#"),
         value.name = c("shannon","cv","a1","a2","a3","a4","a5","a6","a7","a8","a9"))
dt
str(dt)

# Remove first two columns without meaningful variables, and add columns
dtt<-dt[,-c(1:2)] # Remove first two unmeaningful columns
dtt[,time_step:=rep.int(1:1600,times=30)] # 1600 time steps repeat for 30 times per variable (6 fishing scenario x 5 replicate)
dtt[,week:=rep.int(1:40,times=1200)] # 40 weeks for 40 years, 30 times per variable=40*30=1200
dtt[,replicate:=rep(rep(1:5,each=1600),6)] # Repeat 5 times for 6 survival scenarios x 0 sd=6
dtt[,survival_coef:=rep(c("S5050","S6060","S7070","S8080","S9090","S100100"),each=1600*5)] # 0 sd x 5 replicate
dtt[,year:=rep(rep(1:40,each=40),times=30)]
dtt[,niche:=0406]



# convert some variables to numeric using lapply, SD, SDcols
str(dtt)
strTmp = c('shannon','cv','a1','a2','a3','a4','a5','a6','a7','a8','a9')
dtt[, (strTmp) := lapply(.SD, as.numeric), .SDcols = strTmp]

# calculate population size
dtt[, population_size := rowSums(.SD), .SDcols = c("a1","a2","a3","a4","a5","a6","a7","a8","a9")]
F35_S0406<-dtt

# 3 Bind two files
f35<-bind_rows(F35_S0208,F35_S0406)
summary(f35)

# 4 reorder for later plots
f35$survival_coef = factor(f35$survival_coef, levels=c("S100100","S9090","S8080","S7070","S6060","S5050"))
f35$survival_coef=as.character(f35$survival_coef)

#5 Rename mean, sd, and values
f35$niche<-as.character(f35$niche)
str(f35)
```


<!-- ## CV~age -->

<!-- ```{r, include=FALSE} -->

<!-- # cv~age diversity -->
<!-- f35[year %in% c(20:30) & week %in% c(30:39) & survival_coef %chin% c("S100100","S9090","S8080","S7070") ] %>% -->
<!--    ggplot(aes(x=shannon, y=cv,color=niche)) + -->
<!--    geom_point(pch=1,cex=0.8)+ -->
<!--    geom_smooth(method="loess")+ -->
<!--    ggtitle("")+ -->
<!--    theme(plot.title = element_text(hjust = 0))+ -->
<!--    labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+ -->
<!--    guides(color=guide_legend("Survival rate of \nage 3 and age 4")) -->


<!-- # x axis between 1.5 and 2.25 -->
<!-- f35[year %in% c(35:39) & week %in% c(30:39)] %>% -->
<!--    ggplot(aes(x=shannon, y=cv,color=niche)) + -->
<!--    geom_point(pch=1,cex=0.8)+ -->
<!--    #geom_smooth(method="lm")+ -->
<!--    ggtitle("")+ -->
<!--    theme(plot.title = element_text(hjust = 0))+ -->
<!--    labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+ -->
<!--    guides(color=guide_legend(""))+ -->
<!--    xlim(1.7,2.25) -->

<!-- ``` -->



<!-- # CV~age by fishing scenario  -->

<!-- ```{r, include=FALSE} -->
<!-- # Group by survival_coef -->
<!-- f35[year %in% c(30:40) & week %in% c(38:39 )] %>% -->
<!--    ggplot(aes(x=shannon, y=cv,color=survival_coef)) + -->
<!--    geom_point(pch=1,cex=0.8)+ -->
<!--    geom_smooth(method="lm")+ -->
<!--    ggtitle("")+ -->
<!--    theme(plot.title = element_text(hjust = 0))+ -->
<!--    labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+ -->
<!--    guides(color=guide_legend("Survival rate of \nage 3 and age 4")) -->
<!-- ``` -->



<!-- # CV~age by year -->
<!-- ```{r, include=FALSE} -->

<!-- f35[year %in% c(1:40) & week %in% c(38:39) & survival_coef %chin% c("S9090","S8080","S7070")] %>% -->
<!--    ggplot(aes(x=shannon, y=cv,color=year)) + -->
<!--    geom_point(pch=1,cex=0.8)+ -->
<!--    geom_smooth(method="loess")+ -->
<!--    ggtitle("")+ -->
<!--    theme(plot.title = element_text(hjust = 0))+ -->
<!--    labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+ -->
<!--    guides(color=guide_legend("Survival rate of \nage 3 and age 4")) -->


<!-- ``` -->




# Experiment 191209 
<!-- In the previous experiment, there are only 5 replicates. -->
<!-- In this experiment, I run more replicates. -->
<!-- Everything is the same except the survival_coef of "50, 50, 50, 50" is not included. -->
<!-- It is because it has too high CV and variations. -->

<!-- Run on Mobydic F35Ind10 -->

Spatial differentiation scenario:
1. Strong spatial differntiation: range between 0.2 and 0.8
2. Weak spatial differentiation: range between 0.4 and 0.6

Survival rates of age 5,6,7,8 are: (in total 5 scenarios)
60,60,60,60
70,70,70,70
80,80,80,80
90,90,90,90
100,100,100,100

Time: 1600 steps (40 years). Every 40 time steps is one year.
Space: 11 rows, 11 columns
Individuals: 100 individuals per age class
Replicate: 30 replicates
Run time: 51 hr on personal Mac (F35_S0406R30), 29hr on Office Mac (F35_S0208R30)
Demography: equal age composition (Use Leslie matrix)


# Animation: survival rate of age 5-8 is 80%, strong spatial differentiation

<video width=100% height="300" controls>
  <source src="F35Fishing80StrongT1600.mp4"
  type="video/mp4">
</video>   


# Animation: survival rate of age 5-8 is 80%, weak spatial differentiation

<video width=100% height="300" controls>
  <source src="F35Fishing80WeakT1600.mp4"
  type="video/mp4">
</video>   

# Animation: survival rate of age 5-8 is 60%, strong spatial differentiation

<video width=100% height="300" controls>
  <source src="F35Fishing60StongT1600.mp4"
  type="video/mp4">
</video>   

# Animation: survival rate of age 5-8 is 60%, weak spatial differentiation

<video width=100% height="300" controls>
  <source src="F35Fishing60WeakT1600.mp4"
  type="video/mp4">
</video>   


```{r F35_S0208R30.txt, include=FALSE}

library(tidyverse)
library(data.table)
library(mapplots)
library(purrr)
library(ggplot2)
library(forcats)
library(viridis)

# use read.delim to read txt 
d<-read.delim("F35_S0208R30.txt",skip = 157,header = F,fill = T,sep = "",strip.white = T, blank.lines.skip = T) # value of "skip" is row of the first line of the data.
d 

# transpose data in data.table
tt<-t(d)
dt<-as.data.table(tt)
colnames(dt)=as.character(dt[1,]) # use the row name of the first row as colnames
dt <- dt[-1,] # delete this fist row

# use melt to combine columns into new columns
dt<-melt(dt,measure.vars = patterns("^lshannon#","lcv#","^la1#","^la2#","^la3#","^la4#","^la5#","^la6#","^la7#","^la8#","^la9#"),
         value.name = c("shannon","cv","a1","a2","a3","a4","a5","a6","a7","a8","a9"))
dt
str(dt)

# Remove first two columns without meaningful variables, and add columns
dtt<-dt[,-c(1:2)] # Remove first two unmeaningful columns
dtt[,time_step:=rep.int(1:1600,times=150)] # 1600 time steps repeat for 150 times per variable (5 fishing scenario x 30  replicate=150)
dtt[,week:=rep.int(1:40,times=6000)] # 40 weeks for 40 years, 
dtt[,replicate:=rep(rep(6:35,each=1600),5)] # Repeat 30 times for 5 survival scenarios 
dtt[,survival_coef:=rep(c("S6060","S7070","S8080","S9090","S100100"),each=1600*30)] # 0 sd x 30 replicate
dtt[,year:=rep(rep(1:40,each=40),times=150)]

dtt[,niche:=0208]


# convert some variables to numeric using lapply, SD, SDcols
str(dtt)
strTmp = c('shannon','cv','a1','a2','a3','a4','a5','a6','a7','a8','a9')
dtt[, (strTmp) := lapply(.SD, as.numeric), .SDcols = strTmp]

# calculate population size
dtt[, population_size := rowSums(.SD), .SDcols = c("a1","a2","a3","a4","a5","a6","a7","a8","a9")]
F35_S0208R30<-dtt

```


```{r F35_S0406R30.txt, include=FALSE}

# use read.delim to read txt 
d<-read.delim("F35_S0406R30.txt",skip = 157,header = F,fill = T,sep = "",strip.white = T, blank.lines.skip = T)
d

# transpose data in data.table
tt<-t(d)
dt<-as.data.table(tt)
colnames(dt)=as.character(dt[1,]) # use the row name of the first row as colnames
dt <- dt[-1,] # delete this fist row

# use melt to combine columns into new columns
dt<-melt(dt,measure.vars = patterns("^lshannon#","lcv#","^la1#","^la2#","^la3#","^la4#","^la5#","^la6#","^la7#","^la8#","^la9#"),
         value.name = c("shannon","cv","a1","a2","a3","a4","a5","a6","a7","a8","a9"))
dt
str(dt)

# Remove first two columns without meaningful variables, and add columns
dtt<-dt[,-c(1:2)] # Remove first two unmeaningful columns
dtt[,time_step:=rep.int(1:1600,times=150)] # 1600 time steps repeat for 150 times per variable (5 fishing scenario x 30  replicate=150)
dtt[,week:=rep.int(1:40,times=6000)] # 40 weeks for 40 years, 
dtt[,replicate:=rep(rep(6:35,each=1600),5)] # Repeat 30 times for 5 survival scenarios 
dtt[,survival_coef:=rep(c("S6060","S7070","S8080","S9090","S100100"),each=1600*30)] # 0 sd x 30 replicate
dtt[,year:=rep(rep(1:40,each=40),times=150)]

dtt[,niche:=0406]


# convert some variables to numeric using lapply, SD, SDcols
str(dtt)
strTmp = c('shannon','cv','a1','a2','a3','a4','a5','a6','a7','a8','a9')
dtt[, (strTmp) := lapply(.SD, as.numeric), .SDcols = strTmp]

# calculate population size
dtt[, population_size := rowSums(.SD), .SDcols = c("a1","a2","a3","a4","a5","a6","a7","a8","a9")]
F35_S0406R30<-dtt

# 3 Bind two files
f35R30<-bind_rows(F35_S0208R30,F35_S0406R30)

# 4 reorder for later plots
f35R30$survival_coef = factor(f35R30$survival_coef, levels=c("S100100","S9090","S8080","S7070","S6060","S5050"))
f35R30$survival_coef=as.character(f35R30$survival_coef)

#5 Rename mean, sd, and values
f35R30$niche<-as.character(f35R30$niche)

# 4 Bind previous data with 5 replicates and later date with 30 replicates
# also remove S5050
f35All<-bind_rows(f35[survival_coef %chin% c("S100100","S9090","S8080","S7070","S6060")],f35R30 )
summary(f35All)
str(f35All)

# Create "var"
f35All<-f35All[,var:=cv*population_size]


which(is.na(f35All$a5)) # Same procedure as in Example 1, but this time with the column of a data frame;
                            # Missing value in x1 at position 1


# Reorder survival again
f35All$survival_coef = factor(f35All$survival_coef, levels=c("S100100","S9090","S8080","S7070","S6060"))


# Examine the data
f35All[survival_coef=="S6060",.N]
f35All[niche=="406",.N]
f35All[niche=="208",.N]

# Add a variable "variance"
f35All<-f35All[,var:=cv*population_size]

```


# Simulation: age structure changes with fishing scenarios

Age structure changes among different fishing scenarios the most in year 2-10. When the age structure stabilizes in later years,there is no obvious age truncation under fishing but a decrease in population size.

Age structure seems to stabilise through time. Probably due to the lack of density-dependent SSB-recruitment setting, there is no obvious age truncation under fishing when the population stabilises in later years.


```{r, echo=FALSE}

# Subset by year interval, aggregate by replicate

f35All.suryear<-f35All[week %in% c(39:39),
                       .(a1=mean(a1),a2=mean(a2),a3=mean(a3),a4=mean(a4),
                         a5=mean(a5,na.rm=T),
                         a6=mean(a6),a7=mean(a7),a8=mean(a8),a9=mean(a9)),
                       by=.(survival_coef,year)]
 
f35All.suryear.merge<-melt(f35All.suryear,measure.vars = patterns("^a"),
         value.name = "mean_number",
         variable.name = "age" )

f35All.suryear.merge$age<-as.numeric(f35All.suryear.merge$age)


plot.age<-function(yearfrom,yearto,yeartitle){
  f35All.suryear.merge[year %in% c(yearfrom:yearto),.(year_number=mean(mean_number)),by=.(survival_coef,age)] %>%
   ggplot(aes(x=age, y=year_number,color=survival_coef)) +
   geom_point(pch=1,cex=1)+
  geom_smooth(aes(x=age,y=year_number),method="lm",formula=y~poly(x,5),se=FALSE)+
   scale_colour_manual(name="",values = c("#41b6c4","#1d91c0","#225ea8","#0c2c84","black"),
                       labels = c("100%","90%","80%","70%","60%"))+
   labs(x = "Age", y = "Abundance")+
  ggtitle(yeartitle)+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), 
          axis.line=element_line(colour = "black"))+
      theme(legend.position="top")+
  # remove legend.title=blank so I can add legend name in scale_colour_manual
  scale_x_continuous(breaks=seq(from=0,to=10,1)) 
  
}

a1<-plot.age(2,10,"Mean abundance of year 2-10")
a2<-plot.age(11,20,"Mean abundance of year 11-20")
a3<-plot.age(21,30,"Mean abundance of year 21-30")
a4<-plot.age(31,40,"Mean abundance of year 31-40")
grid.arrange(a1, a2, a3,a4,ncol = 2)
??grid.arrange

```


# Simulation: age diversity changes over time
Higher fishing mortality results in lower age diversity (shannon index).

Except S6060, age diversity under one fishing scenario doesn't change much with year. This is in contrast with changes in abundance. Abundance has clear continuous decline with years.

I will mainly compare at each time period, how different fishing scenarios change age diversity, rather than looking at how age diversity changes over time.


```{r,echo=FALSE}

f35All[year %in% c(2:40) & week %in% c(39:39) ] %>%
   ggplot(aes(x=year, y=shannon,color=survival_coef)) +
   geom_point(pch=1,cex=0.5)+
   geom_smooth(method="loess",lwd=0.5)+
   
   scale_colour_manual(values = c("#41b6c4","#1d91c0","#225ea8","#0c2c84","black"))+
   labs(x = "Year", y = "Age diversity (Shannon index)")+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())

```


# Simulation: age diversity under fishing scenarios

Overall, age diversity decreases with higher fishing mortality. 

In year 31-40, age diversity differs the most between fishing scenarios  (the age diversity range is the highest).

```{r,echo=FALSE}

plot.fishing<-function(yearfrom,yearto,yeartitle)
  {
  f35All[year %in% c(yearfrom:yearto) & week %in% c(39:39) ] %>%
   ggplot(aes(x=survival_coef, y=shannon)) +
   geom_boxplot()+
   labs(x = "Fishing scenario (Survival rate of age 5-8)",
        y = "Age diversity (Shannon index)")+
   ggtitle(yeartitle)+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())+
  scale_x_discrete(labels=c("100%","90%","80%","70%","60%"))
  }
  
f1<-plot.fishing(2,10,"Year 2-10")
f2<-plot.fishing(11,20,"Year 11-20")
f3<-plot.fishing(21,30,"Year21-30")
f4<-plot.fishing(31,40, "Year 31-40")
grid.arrange(f1, f2, f3,f4,ncol = 2)
  
```



# Simulation: population size changes over time

Rate of decline in abundance with year is higher under higher fishing mortality.
The rate of decline is faster in earlier years, and stabilized in later years.


```{r , echo=FALSE}

f35All[year %in% c(2:40) & week %in% c(39:39) ] %>%
   ggplot(aes(x=year, y=population_size,color=survival_coef)) +
   geom_point(pch=1,cex=0.5)+
   geom_smooth(method="loess",lwd=0.5)+
   ggtitle("Year 2-40, end of the year (week 39)")+
   scale_colour_manual(values = c("#41b6c4","#1d91c0","#225ea8","#0c2c84","black"))+
   labs(x = "Year", y = "Population size")+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())

```


# Simulation: abundance under fishing scenarios

In longer simulation years, severe fishing results in lower abundance, thus higher variability in abundance between fishing scenarios. 

```{r,echo=FALSE}

plot.fishing<-function(yearfrom,yearto,yeartitle)
  {
  f35All[year %in% c(yearfrom:yearto) & week %in% c(39:39) ] %>%
   ggplot(aes(x=survival_coef, y=population_size)) +
   geom_boxplot()+
   labs(x = "Fishing scenario (Survival rate of age 5-8)",
        y = "Population size")+
   ggtitle(yeartitle)+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())+
  scale_x_discrete(labels=c("100%","90%","80%","70%","60%"))+ylim(0,1000)
  }
  
f1<-plot.fishing(2,10,"Year 2-10")
f2<-plot.fishing(11,20,"Year 11-20")
f3<-plot.fishing(21,30,"Year 21-30")
f4<-plot.fishing(31,40, "Year 31-40")
grid.arrange(f1, f2, f3,f4,ncol = 2)
  
```


# Simulation: fishing scenarios
Higher fishing mortality results in higher variability and range in age diversity and cv. Specifically, there is more reduction in age diversity and increase in cv.

Differences in cv-age slopes between fishing scenarios are results from age diversity+abundance
- for mild fishing, age diversity remains similar with time while changes in abundance is relatively bigger.
- for intensive fishing, both age diversity and abundance change significantly with time.

Different fishing scenarios creates different abundance. Thus, the more fishing scenarios we include, we may find high variability in CV with the same age diversity.

```{r by fishing scenario, echo=FALSE}

# Group by survival_coef
f35All[year %in% c(2:40) & week %in% c(39:39 )] %>%
   ggplot(aes(x=shannon, y=cv,color=survival_coef)) +
   geom_point(pch=1,cex=0.5)+
   ggtitle("Year 2-40,end of year (week 39)")+
   labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+
   guides(color=guide_legend("Fishing scenario \n(Mortality rate of age 5-8)"))+
   theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="right")

# Subplot
f35All[year %in% c(2:40) & week %in% c(39:39 )] %>%
   ggplot(aes(x=shannon, y=cv,color=survival_coef)) +
   geom_point(pch=1,cex=0.5)+
   #geom_smooth(method="lm")+
  facet_wrap(~survival_coef, scales="fixed",strip.position = "top",as.table=F,ncol=5)+
   ggtitle("Year 2-40,end of year (week 39)")+
   labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+
   guides(color=guide_legend("Fishing scenario \n(Mortality rate (%) of age 5-8)"))+
  theme_bw()+
  theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top")

```



# 1 cv-age relationship under high and low differentiation (all data)

It appears to have no clear differences in age-cv relationship between high and low differentiation scenarios when including all data of 40 years.
```{r, echo=FALSE}

f35All[year %in% c(2:40) & week %in% c(39:39) ] %>%
   ggplot(aes(x=shannon, y=cv,color=niche)) +
   geom_point(pch=1,cex=0.3)+
   #geom_smooth(method="loess")+
   ggtitle("Year 2-40, end of the year (week 39)")+
   scale_colour_manual(values = c("#0072b2","#d55e00"),
                       labels = c("High differentiation","Low differentiation"))+
   labs(x = "Age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())

```


# 2 cv-age relationship under differentiation scenarios, subplots with year (fixed scale)
Simulating for longer time contributes to more declines in age diversity.
*Both simulation year and fishing scenario contributes to age-cv relationship.*

```{r, echo=FALSE }
library(gridExtra)
plot.year.scaled<-function(yearfrom,yearto,yeartitle)
  {
  f35All[year %in% c(yearfrom:yearto) & week %in% c(39:39) ] %>%
   ggplot(aes(x=shannon, y=cv,color=niche)) +
   geom_point(pch=1,cex=0.1)+
   geom_smooth(method="loess")+
   ggtitle(yeartitle)+
   scale_colour_manual(values = c("#0072b2","#d55e00"),
                       labels = c("High differentiation","Low differentiation"))+
   labs(x = "Age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())+
    xlim(1,2.2)+ylim(0,5)
}

p1<-plot.year.scaled(2,10,"Year 2-10")
p2<-plot.year.scaled(11,20,"Year 11-20")
p3<-plot.year.scaled(21,30,"Year 21-30")
p4<-plot.year.scaled(31,40, "Year 31-40")
grid.arrange(p1, p2, p3,p4,ncol = 2)

```



# 3 cv-age relationship under differentiation scenarios, subplots with year (free scale)
Differences in age-cv relationship between high and low differentiation scenarios appear in earlier simulation years.

CV seems to be more sensitive to age diversity with the high differentiation scenario between year 2-10. The difference is less obvious with longer simulation years.

Less obvious differences between high and low differentiation scenarios after year 11 is possibly due to that cv is driven more by abudance rather than age diversity (abundance changes a lot while age diversity doesn't change that much).


```{r,echo=FALSE}

plot.year<-function(yearfrom,yearto,yeartitle)
  {
  f35All[year %in% c(yearfrom:yearto) & week %in% c(39:39) ] %>%
   ggplot(aes(x=shannon, y=cv,color=niche)) +
   geom_point(pch=1,cex=0.8)+
   geom_smooth(method="loess")+
   ggtitle(yeartitle)+
   scale_colour_manual(values = c("#0072b2","#d55e00"),
                       labels = c("High differentiation","Low differentiation"))+
   labs(x = "Age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())
}

p1<-plot.year(2,10,"Year 2-10")
p2<-plot.year(11,20,"Year 11-20")
p3<-plot.year(21,30,"Year21-30")
p4<-plot.year(31,40, "Year 31-40")
grid.arrange(p1, p2, p3,p4,ncol = 2)

```






# Why CV-age difference between high and low differentiation is less obvious with longer simulation time

When the simulation year is longer, abundance is then lower. CV has lower power in explaining spatial heterogeneity if the spatial scale for calculating CV is low. 

<!-- "When distribution depends on a heterogenous environment, niche assembly is stronger at intermediate or large scale, rather than neighborhood scale " (Andreas et al,2019, Okios) -->

<!-- *To solve this (so that CV at low abundance also explains spatial heterogeneity):* -->
<!-- - One way is to increase population size. But I have already increase to 100 ind per age, which is computationally limited. -->

<!-- - The second way is to increase spatial scale while calculating CV. It is more computational-efficient. In Mobydic I need to record simulation results for each cell and compute. -->

<!-- - The third way is to find alternative indicator for spatial heterogeneity. -->

<!-- - The best way is probably to add more severe fishing scenarios while keeping the simulation year up to 20 years. As the current Leslie matrix of equal age composition have stabilised age strucutre since early years. Also, we see that within the same year range, higher fishing mortality contributes to more obvious differences between high and low spatial differentiation. -->

## Solutions

1. Enlarge grid size when abundance decrease, for calculating CV

2. Use alternative indicator for spatial heterogeneity

3. Simulate up to 20 years, increase fishing intensity


![](Pic_Andreas.png)
<!-- ![](Pic_scale2.jpg) -->

<!-- -An example from simulating severe fishing scenario (survival rate of age 5-8 is 60%) with high and low spatial differentiation. -->

<!-- 1. At year 15 (time step 599), cv of high differentiation is higher than cv of low differentiation -->
<!-- ![](Pic_F35Fishing60StrongYear15T599.png){width=400} -->

<!-- ![](Pic_F35Fishing60WeakYear15T599.png){width=400} -->


<!-- 2. At year 30-35 (time step 1159), the abundance is lower. -->
<!-- cv is similar between high and low differentiation. But if the spatial scale for calcualing cv is higher, cv of high differentiaiton will be much higher than of low differentiation. -->

<!-- ![](Pic_F35Fishing60StrongYear30T1159.png){width=400} -->


<!-- ![](Pic_F35Fishing60WeakYear35T1429.png){width=400} -->


# cv~age by fishing scenario and year
Simulation year has a global effect on differences in age-cv between high and low differentiation. The difference disappear with longer simulation years.

Within the same year range, higehr fishing mortality results in higher ranges in age diversity and range, thus contributes more to the clear differences between high and low differentiation.

```{r subplots of survival_coef, echo=FALSE}
# fixed scale
plot.fish.year<-function(yearfrom,yearto,title){
  f35All[year %in% c(yearfrom:yearto) & week %in% c(39:39)] %>%
   ggplot(aes(x=shannon, y=cv,color=niche)) +
   geom_point(pch=1,cex=0.4)+
   geom_smooth(method="loess")+
    scale_colour_manual(values = c("#0072b2","#d55e00"),
                       labels = c("High differentiation","Low differentiation"))+
   facet_wrap(~survival_coef, scales="fixed",strip.position = "top",as.table=T,ncol=5)+
   ggtitle(title)+
   labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+
   guides(color=guide_legend("Survival rate of \nage 3 and age 4"))+
  theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())

}

plot.fish.year(2,10,"Year 2-10 end of year (week 39)")
plot.fish.year(11,20,"Year 11-20 end of year (week 39)")
plot.fish.year(21,30,"Year 21-30 end of year (week 39)")
plot.fish.year(31,40,"Year 31-40 end of year (week 39)")

# free x scale
plot.fish.year<-function(yearfrom,yearto,title){
  f35All[year %in% c(yearfrom:yearto) & week %in% c(39:39)] %>%
   ggplot(aes(x=shannon, y=cv,color=niche)) +
   geom_point(pch=1,cex=0.4)+
   geom_smooth(method="loess")+
    scale_colour_manual(values = c("#0072b2","#d55e00"),
                       labels = c("High differentiation","Low differentiation"))+
   facet_wrap(~survival_coef, scales="free_x",strip.position = "top",as.table=T,ncol=5)+
   ggtitle(title)+
   labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+
   guides(color=guide_legend("Survival rate of \nage 3 and age 4"))+
  theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())

}

plot.fish.year(2,10,"Year 2-10 end of year (week 39)")
plot.fish.year(11,20,"Year 11-20 end of year (week 39)")
plot.fish.year(21,30,"Year 21-30 end of year (week 39)")
plot.fish.year(31,40,"Year 31-40 end of year (week 39)")


# # How does cv-age relationship change with each fishing scenario over time (need revision, codes don't seem to be correct)
# plot.fish.year<-function(yearfrom,yearto,title){
#   f35All[year %in% c(yearfrom:yearto) & week %in% c(39:39)] %>%
#    ggplot(aes(x=shannon, y=cv,color=niche)) +
#    geom_point(pch=1,cex=0.4)+
#    geom_smooth(method="loess")+
#     scale_colour_manual(values = c("#0072b2","#d55e00"),
#                        labels = c("High differentiation","Low differentiation"))+
#    facet_wrap(~survival_coef, scales="free_x",strip.position = "top",as.table=T,ncol=5)+
#    ggtitle(title)+
#    labs(x = "age diversity (Shannon index)", y = "Spatial heterogeneity (cv)")+
#    guides(color=guide_legend("Survival rate of \nage 3 and age 4"))+
#   theme_bw()+
#     theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
#                     =element_line(colour = "black"))+
#       theme(legend.position="top",legend.title = element_blank())
# 
# }
# 
# plot.fish.year(2,10,"Year 2-10 end of year (week 39)")
# plot.fish.year(11,20,"Year 11-20 end of year (week 39)")
# plot.fish.year(21,30,"Year 21-30 end of year (week 39)")
# plot.fish.year(31,40,"Year 31-40 end of year (week 39)")



```



# 1 Abundance~age diversity
From year 11 on, at high age diversity range, population size has high variability. In this case, cv changes mainly due to changes in abundnace. 


```{r, echo=FALSE}

f35All$population_size<-as.numeric(f35All$population_size)

plot.year<-function(yearfrom,yearto,yeartitle)
  {
  f35All[year %in% c(yearfrom:yearto) & week %in% c(39:39) ] %>%
   ggplot(aes(x=shannon, y=population_size)) +
   geom_point(pch=1,cex=0.8)+
   geom_smooth(method="loess")+
   ggtitle(yeartitle)+
   scale_colour_manual(values = c("#0072b2","#d55e00"),
                       labels = c("High differentiation","Low differentiation"))+
   labs(x = "Age diversity (Shannon index)", y = "Population size")+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())
}


p1<-plot.year(2,10,"Year 2-10")
p2<-plot.year(11,20,"Year 11-20")
p3<-plot.year(21,30,"Year21-30")
p4<-plot.year(31,40, "Year 31-40")
grid.arrange(p1, p2, p3,p4,ncol = 2)

```


# Relationships between cv, abundance, standard deviation
During year 2-10, the same abundance between high and low spatial differentiation scenario results in different cv, revealing that cv is determined by other factors than only abundance.

While after year 11, the dependence of cv on abundance doesn't change between high and low spagtial differentiation, suggesting that cv is heavily dependent on abundnace rather than other factors (such as age diversity, as we want to test). 

```{r }

# p1: cv~abundance
f35All[year %in% c(2:40) & week %in% c(39:39) ] %>%
   ggplot(aes(x=population_size, y=cv)) +
   geom_point(pch=1,cex=0.3)+
   #geom_smooth(method="loess")+
   ggtitle("")+
   labs(x = "Population size", y = "Spatial heterogeneity (cv)")+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())
 

# p1-1: cv~abundance by differentiation scenarios

plot<-function(yearfrom,yearto,yeartitle)
  {
  f35All[year %in% c(yearfrom:yearto) & week %in% c(39:39) ] %>%
   ggplot(aes(x=population_size, y=cv,color=niche)) +
   geom_point(pch=1,cex=0.8)+
   geom_smooth(method="loess")+
   ggtitle(yeartitle)+
   scale_colour_manual(values = c("#0072b2","#d55e00"),
                       labels = c("High differentiation","Low differentiation"))+
   labs(x = "Population size", y = "Spatial heterogeneity (cv)")+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())
}

p1<-plot(2,10,"Year 2-10")
p2<-plot(11,20,"Year 11-20")
p3<-plot(21,30,"Year21-30")
p4<-plot(31,40, "Year 31-40")
grid.arrange(p1, p2, p3,p4,ncol = 2)





```     

```{r }      
# p2 cv~standard deviation
f35All[year %in% c(2:40) & week %in% c(39:39) ] %>%
   ggplot(aes(x=cv/population_size, y=cv)) +
   geom_point(pch=1,cex=0.3)+
   #geom_smooth(method="loess")+
   ggtitle("")+
   labs(x = "Standard deviation", y = "Spatial heterogeneity (cv)")+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())
```

```{r }
# p3 standard deviation~mean
f35All[year %in% c(2:40) & week %in% c(39:39) ] %>%
   ggplot(aes(x=population_size, y=cv/population_size)) +
   geom_point(pch=1,cex=0.3)+
   #geom_smooth(method="loess")+
   ggtitle("")+
   labs(x = "Population size", y = "Standard deviation")+
   theme_bw()+
    theme(panel.grid.major = element_blank(),panel.grid.minor = element_blank(), axis.line
                    =element_line(colour = "black"))+
      theme(legend.position="top",legend.title = element_blank())



```


# Next steps and timeline (Discussed with Zac on Dec 23)

- Paper structure: Clarify age-specific habitat preference, and add a) environment heterogeneity, and 2) density-dependent

- IBM in R in paralle 

- The updated results will be presented in Ecological Society Japan, March 2020, Okasa.


# Model improvement

*Spatial differentiation peak distance (limiting similarity)*: 

- Do the niche distribution curves overlap too closely?


*Indicators*

- Shannon index: I can also try other age diversity index than Shanon index

- CV: It is the best to keep the grid size for calculation through time. Change the grid size is the last option as it is not consistent. 

- Alternative indicator of CV: patchiness.


*Simulation years and population size*

- To simulate until 20 years. After 20 years the mean abundance is lower, cv is driven by abundance rather than age diversity. 

- Reduce individuals per age from 100 to lower numebr if I use more age classes.


*Increase the range of age diversity*

- Increase fishing intensity and/or design different fishing scenarios to make age truncation more obvious. For example, a gradient of higher fishing mortality from age 5 to 8. Draw age structure truncation with different scenarios, to confirm that age truncation and changes in age divesity is clear enough.

- Initial age structure. I set equal distribution as the initial condition for the moment. So that the changes in age diversity is accompanied with great reduction in abundance. If I set right skewed age structure at the beginning, I may alter age diversity while not alter abundance that much. The aim is to make age diversity as low as possible, while abundance doesnt change that much. In this way we can disentangle the effect of abundance and age diversity on spatial heterogeneity.

- When setting fishing scenarios, make old classes disappear one by one, for example. Disappearance of old age classes will create a big range of diversity change. Even when there is one individual for one age class, Shannon index is still quite high. The aim is to make age diversity change significantly within 20 years. So the tails are dispearing.

- Increase fish age classes to 13 classes to enlarge age diversity range. 

- Ricker recruitment~SSB shows density-dependent recruitment, which may help create lower age diversity. But I can consider at a later stage.  It is better to make the model as simple as possible.

- Set a threshold for each age: when then number of a certain age reaches this threshold, the whole age will disappear (But does it happen in reality?)

- Compared to skewed age distribution as no fishing scenario, equal age distribution can reach a higher maximum age diversity. However, the abundance loss after fishing is also more, so that there is a big change in abundance which may mask the effects of changes in age diversity.

- Leslie matrix assumes stable age structure and population growth rate. In reality, fish populations under exploitation may not have stable age structure through time. It is probably due to non-linear density-dependent SSB-recruitment relationship. 

- The aim is to set different fishing scenarios to enlarge age diversity range while limiting declines in population size. Adding density-dependent recruitment term may help a lot.

